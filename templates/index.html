<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Python GA Feature Selection</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; }
    section { margin-top: 1rem; }
    input, button { margin: 5px; }
    pre { background: #f5f5f5; padding: 1rem; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Feature Selection using Genetic Algorithm (Python + Flask)</h1>

  <section>
    <h3>Upload Dataset (CSV)</h3>
    <input type="file" id="csvFile" accept=".csv">
    <div id="datasetInfo"></div>
  </section>

  <section id="columnSelection" style="display:none;">
    <h3>Column Configuration</h3>
    <label>ID Column (leave empty if no ID): <input id="idColumn" type="text" placeholder="e.g., 0 or leave empty"></label><br>
    <label>Target Column: <input id="targetColumn" type="text" placeholder="e.g., 4" required></label>
    <p style="font-size: 0.9em; color: #666;">Note: Column indices start from 0. Check the dataset info above for column numbers.</p>
  </section>

  <section>
    <h3>GA Parameters</h3>
    <label>Population: <input id="popSize" type="number" value="30"></label>
    <label>Crossover: <input id="crossRate" type="number" value="0.7" step="0.05"></label>
    <label>Mutation: <input id="mutRate" type="number" value="0.1" step="0.01"></label>
    <label>Max Generations: <input id="maxGen" type="number" value="20"></label>
    <label>Convergence Threshold: (leave empty if no need it)<input id="convergenceThreshold" type="number" value="" step="0.0001"></label>
    <button onclick="runGA()">Run GA</button>
    <p style="font-size: 0.9em; color: #666;">Note: Algorithm stops when relative improvement falls below the convergence threshold or max generations is reached.</p>
  </section>

  <section>
    <h3>Status</h3>
    <pre id="status">Waiting for dataset...</pre>
  </section>

  <section>
    <h3>Progress</h3>
    <canvas id="chart" height="120"></canvas>
  </section>

  <script>
    let csvData = "";

    document.getElementById("csvFile").addEventListener("change", e => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        csvData = reader.result;
        const lines = csvData.split("\n").filter(x => x.trim());
        const headers = lines[0].split(",");
        
        // Show columns with their indices
        const columnInfo = headers.map((h, i) => `[${i}] ${h.trim()}`).join(", ");
        document.getElementById("datasetInfo").textContent =
          `File loaded: ${file.name}\nColumns: ${columnInfo}\nRows: ${lines.length - 1}`;
        
        // Show column selection section
        document.getElementById("columnSelection").style.display = "block";
        
        // Set default values: last column as target
        document.getElementById("targetColumn").value = headers.length - 1;
        document.getElementById("idColumn").value = "";
      };
      reader.readAsText(file);
    });

    async function runGA() {
      if (!csvData) {
        alert("Please upload a CSV first!");
        return;
      }

      const targetColumn = document.getElementById('targetColumn').value;
      if (!targetColumn && targetColumn !== "0") {
        alert("Please specify the target column!");
        return;
      }

      const popSize = document.getElementById('popSize').value;
      const crossRate = document.getElementById('crossRate').value;
      const mutRate = document.getElementById('mutRate').value;
      const maxGen = document.getElementById('maxGen').value;
      const convergenceThreshold = document.getElementById('convergenceThreshold').value;
      const idColumn = document.getElementById('idColumn').value;

      document.getElementById("status").textContent = "Running...";

      // Build request body
      const requestBody = {
        popSize, 
        crossRate, 
        mutRate, 
        maxGen, 
        csvData,
        idColumn: idColumn === "" ? null : parseInt(idColumn),
        targetColumn: parseInt(targetColumn)
      };
      
      // Only include convergenceThreshold if it has a value
      if (convergenceThreshold !== "") {
        requestBody.convergenceThreshold = parseFloat(convergenceThreshold);
      }

      const res = await fetch("/run_ga", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(requestBody)
      });

      const data = await res.json();

      if (data.error) {
        document.getElementById("status").textContent = `❌ Error: ${data.error}`;
        return;
      }

      const selectedCount = data.selectedFeatures.length;
      const idInfo = data.idColumn ? `ID Column: ${data.idColumn}\n` : `No ID column\n`;
      const convergenceInfo = data.converged ? `Converged at generation ${data.generations}` : `Completed ${data.generations} generations (max reached)`;
      document.getElementById("status").textContent =
        `✅ Done!\n${idInfo}Target Column: ${data.target}\n` +
        `${convergenceInfo}\n` +
        `Best fitness: ${data.bestFitness}\n` +
        `Selected features: ${selectedCount} out of ${data.featuresCount} (${data.selectedFeatures.join(", ")})\n` +
        `Total features: ${data.featuresCount}, Rows: ${data.rows}`;

      const ctx = document.getElementById("chart");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: data.history.map((_, i) => i + 1),
          datasets: [{ label: "Best Fitness", data: data.history, borderColor: "#2563eb", fill: false }]
        },
        options: { responsive: true, animation: false }
      });
    }
  </script>
</body>
</html>
